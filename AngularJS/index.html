<!doctype html>
<html lang="pt-br" ng-app="Listatelefonica">
<head>
    <script src="lib/angular/angular.min.js"></script>
    <script src="lib/angular/angular-messages.min.js"></script>
    <link rel="stylesheet" type="text/css" href="lib/bootstrap/bootstrap.min.css">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Lista Telefônica</title>
</head>
<style>
    .jumbotron{
        width: 600px;
        text-align: center;
        margin-top: 18px;
        margin-left: auto;
        margin-right: auto;
        padding-top: 28px;
        padding-bottom: 28px;
    }

    .table{
        margin-top: 20px;
    }

    .table th{
        background-color: #FF7C78;
        color: white;
    }

    .table td{
        background: ghostwhite;
    }

    .table:hover{
        color: black;
    }

    .form-control{
        margin-bottom: 5px;
    }

    .selecionado{
        background-color: rgb(26%, 67%, 62%);
    }

    .negrito{
        font-weight: bold;
    }

    .alert-danger{
        margin-bottom: 20px;
    }

    .fa-phone-square:hover{
        color: #FF7C78;
    }

</style>
<body ng-controller="ListaTelefonicaCtrl">
<script>
    angular.module("Listatelefonica", ["ngMessages"]);
    angular.module("Listatelefonica").controller("ListaTelefonicaCtrl", function ($scope, $http) {
        $scope.app = "Lista Telefônica";

        $scope.contatos = [];


        var carregarContatos = function () {
          $http.get("https://agendaapi.herokuapp.com/api/contatos").then(function (data) {
              console.log(data.data._embedded.contatos);
              console.log(data.data._embedded.contatos[0]._links.self.href);
              $scope.contatos = data.data._embedded.contatos;
          }).catch(function (data, status) {
              $scope.message = "Aconteceu um problema: " + data;
          });
        };


        $scope.classe1 = "selecionado";
        $scope.classe2 = "negrito";

        $scope.isContatoSelecionado2 = function (contato) {
            $scope.nome2 = contato.nome;
            $scope.telefone2 = contato.telefone;
            $scope.email2 = contato.email;
            $scope.tipo2 = contato.tipo;
            $scope.linkid = contato._links.self.href;
            $scope.contatoUpdate = contato;
            console.log($scope.contatoUpdate);
            console.log(contato._links.self.href);
           return contato;
        };

        $scope.isContatoSelecionado = function (contatos) {
           return contatos.some(function (contato) {
               //console.log(contato);
                return contato.selecionado;
            });
        };

        $scope.adicionarContato = function (contato) {
            $http.post("https://agendaapi.herokuapp.com/api/contatos", contato).then(function (data) {
                delete $scope.contato;
                $scope.contatoForm.$setPristine();
                carregarContatos();
            });
        };

        $scope.apagarContatos = function (contatos) {
          $scope.contatos =   contatos.filter(function (contato) {
                if(contato.selecionado){
                    $http.delete(contato._links.self.href);
                    carregarContatos();
                }
            });
        };

        $scope.atualizarContato = function (contato) {
            contato = {nome: $scope.nome2, telefone: $scope.telefone2, email: $scope.email2, tipo: $scope.tipo2};
            $http.patch($scope.linkid, contato).then(function (data) {
                $scope.contatoForm.$setPristine();
                carregarContatos();
            });

        };

        $scope.ordenarPor = function (campo) {
            $scope.criterioDeOrdenacao = campo;
            $scope.direcaoDaOrdenacao = !$scope.direcaoDaOrdenacao;

        };

        carregarContatos();
        //carregarOperadoras();
    });
</script>

<div class="jumbotron">
    <i class="fa fa-phone-square fa-3x" aria-hidden="true">Agenda telefônica</i>
    <hr/>
    <input class="form-control" type="search" ng-model="criterioDeBusca" placeholder="O que está buscando?"/>
    {{message}}
    {{contato.nome}}
    <table ng-show="contatos.length > 0" class="table table-bordered">
        <tr>
            <th></th>
            <th>Nome</th>
            <th>Telefone</th>
            <th>E-mail</th>
            <th>Tipo</th>
           <!-- <th>ID</th> -->
            <th>Editar</th>
        </tr>
        <tr ng-class="{'selecionado negrito': contato.selecionado}" ng-repeat="contato in contatos  | filter:criterioDeBusca | orderBy:criterioDeOrdenacao:direcaoDaOrdenacao">
            <td><input type="checkbox" ng-model="contato.selecionado"></td>
            <td>{{contato.nome}}</td>
            <td>{{contato.telefone}}</td>
            <td>{{contato.email | lowercase}}</td>
            <td>{{contato.tipo}}</td>
           <!-- <td>{{contato.$$hashKey}}</td> -->
            <td><a class="btn" href="#" data-toggle="modal" data-target="#myModal" ng-click="isContatoSelecionado2(contato)">
                <i class="fa fa-pencil-square-o"></i>
            </a></td>
        </tr>
    </table>
    <hr/>

    <form name="contatoForm">
    <input class="form-control" type="text" name="nome" ng-model="contato.nome" placeholder="Nome" ng-required="true" ng-minlength="10"/>
    <input class="form-control" type="text" name="telefone" ng-model="contato.telefone" placeholder="Telefone" ng-required="true" ng-pattern="/^\d{4,5}-\d{4}$/"/>
    <input class="form-control" type="email" name="emailContato" ng-model="contato.email" placeholder="E-mail" ng-required="true"/>
    <!--    <select class="form-control" ng-model="contato.tipo"  ng-options="tipoo as tipoo.tipo for tipoo in contatos">
        <option value="">Selecione o tipo de contato</option>
    </select> -->
    <input class="form-control" type="text" name="tipo" ng-model="contato.tipo" placeholder="Tipo contato. Ex: AMIGO" ng-required="true"/>
    <button class="btn btn-primary btn-block" ng-click="adicionarContato(contato)"
                            ng-disabled="contatoForm.$invalid">Adicionar Contato</button>

    <button class="btn btn-danger btn-block" ng-click="apagarContatos(contatos)"
            ng-if="isContatoSelecionado(contatos)">Apagar Contatos</button>
    </form>

    <br/>

    <div ng-messages="contatoForm.nome.$error" class="alert alert-danger">

    <div ng-message="required">
        Por favor, preencha o campo nome!
    </div>

    <div ng-message="minlength">
        O campo nome deve ter no mínimo 10 caracteres!
    </div>

    </div>
    <div ng-show="contatoForm.telefone.$error.required && contatoForm.telefone.$dirty" class="alert alert-danger">
        Por favor, preencha o campo telefone!
    </div>

    <div ng-show="contatoForm.telefone.$error.pattern" class="alert alert-danger">
        O campo telefone deve ter o formato: 00000-0000
    </div>

</div>
<!-- Trigger the modal with a button -->
<!--<button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal">Open Modal</button>
-->
<!-- Modal -->
<!-- line modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                <h3 class="modal-title" id="lineModalLabel">Contato - Atualizar</h3>
            </div>
            <div class="modal-body">

                <!-- content goes here -->
                <form name="contatoForm1">

                    <input class="form-control" type="text" name="nome" ng-model="nome2"
                           placeholder="Nome" ng-required="true" ng-minlength="10"/>
                    <input class="form-control" type="text" name="telefone" ng-model="telefone2"
                           placeholder="Telefone" ng-required="true" ng-pattern="/^\d{4,5}-\d{4}$/"/>
                    <input class="form-control" type="email" name="emailContato" ng-model="email2"
                           placeholder="E-mail" ng-required="true"/>
                    <!--    <select class="form-control" ng-model="contato.tipo"  ng-options="tipoo as tipoo.tipo for tipoo in contatos">
                        <option value="">Selecione o tipo de contato</option>
                    </select> -->
                    <input class="form-control" type="text" name="tipo" ng-model="tipo2" placeholder="Tipo contato. Ex: AMIGO" ng-required="true"/>

                    <button class="btn btn-primary btn-block" ng-click="atualizarContato($scope.contatoUpdate)"
                            data-dismiss="modal" ng-disabled="contatoForm1.$invalid">Atualizar Contato</button>
                </form>

                <br/>

                <div ng-messages="contatoForm1.nome.$error" class="alert alert-danger">

                    <div ng-message="required">
                        Por favor, preencha o campo nome!
                    </div>

                    <div ng-message="minlength">
                        O campo nome deve ter no mínimo 10 caracteres!
                    </div>

                </div>
                <div ng-show="contatoForm1.telefone.$error.required && contatoForm.telefone.$dirty" class="alert alert-danger">
                    Por favor, preencha o campo telefone!
                </div>

                <div ng-show="contatoForm1.telefone.$error.pattern" class="alert alert-danger">
                    O campo telefone deve ter o formato: 00000-0000
                </div>

            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
<div ng-include="'footer.html'"></div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script>

</script>
</body>
</html>