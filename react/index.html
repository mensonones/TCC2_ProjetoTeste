<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>React Local</title>
    <!-- Import the React, React-Dom and Babel libraries from unpkg -->
    <script src="https://unpkg.com/react@15/dist/react.js"></script>
    <script src="https://unpkg.com/react-dom@15/dist/react-dom.js"></script>
    <script type="application/javascript" src="https://unpkg.com/babel-standalone@6.26.0/babel.js"></script>

    <style>
        .card {
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
            transition: 0.3s;
            width: 20%;
        }

        .card:hover {
            box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
        }

        .container {
            padding: 2px 16px;
        }

        .container-form {
            position: absolute;
            top: 10px;
            right: 0;
            width: 400px;
            height: 200px;
            border: 2px solid darkgrey;

        }

        .div-form{
            margin:0;
            padding:0
        }
        .card-alinhar {
            margin:0;
            padding:0
        }
        input[type=text] {padding:5px; border:2px solid #ccc;
            -webkit-border-radius: 5px;
            border-radius: 5px;
        }
        input[type=text]:focus {border-color:#333; }

        input[type=email]:focus {border-color:#333; }
        input[type=email] {padding:5px; border:2px solid #ccc;
            -webkit-border-radius: 5px;
            border-radius: 5px;
        }

        input[type=tel]:focus {border-color:#333; }
        input[type=tel] {padding:5px; border:2px solid #ccc;
            -webkit-border-radius: 5px;
            border-radius: 5px;
        }

        .estilo-btn {
            padding:5px 15px;
            background:#ccc; border:0 none;
            cursor:pointer;
            -webkit-border-radius: 5px;
            border-radius: 5px;
        }

    </style>

</head>

<body>
<div id="root"></div>

<script data-plugins="transform-es2015-modules-umd" type="text/babel">
    class Agenda extends React.Component {

        constructor(props){
            super(props);
            this.state = {
                data: [{
                    nome: '',
                    telefone: '',
                    email: '',
                    imagem: null,
                    tipo: '',
                }],
                dataModal: [{
                    nome: '',
                    telefone: '',
                    email: '',
                    imagem: null,
                    tipo: '',
                }],
                isOpen: false,
            };
            this.toggleModal = this.toggleModal.bind(this);
            this.getObjeto = this.getObjeto.bind(this);
        }


        toggleModal() {
            this.setState({
                isOpen: !this.state.isOpen
            });
        }

        async componentDidMount() {
            try {
                const res = await fetch('//127.0.0.1:8000/api/');
                const data = await res.json();
                this.setState({
                    data
                });
                console.log(data);
            } catch (e) {
                console.log(e);
            }
        }

        imageUpload(e) {
            const reader = new FileReader();
            const file = e.target.files[0];

            reader.onload = (upload) => {
                this.setState({
                    imagem: upload.target.result,
                });
                console.log(upload.target.result);
            };

            reader.readAsDataURL(file);
        };

        async enviarDados(e, file){

            e.preventDefault();

            const {nome, telefone, email, imagem, tipo} = this.state;

           // const newData = {
           //     nome: this.state.nome,
           //     telefone: this.state.telefone,
            //    email: this.state.email,
            //    imagem: this.state.imagem,
           //     tipo: this.state.tipo,
          //  };

            const options = {
                method: 'post',
                headers: {
                    'Accept': 'application/json, text/plain, */*, multipart/form-data',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({'nome':nome, 'telefone':telefone, 'email':email,
                    'imagem':imagem, 'tipo':tipo})

            };

            fetch('//127.0.0.1:8000/api/', options)
                .then(response => {
                    console.log('aqui: '+ response)
                    if (response.ok) {
                        //return response.json();
                       // this.setState({data:[newData, ...this.state.data]})
                        this.setState({nome: '', imagem: '', email: '', telefone: '', tipo: ''})
                    } else {
                        throw new Error('Something went wrong ...');
                    }
                })
                .catch(error => this.setState({error}));
        }

        onChange(e){
            const state = this.state;
            console.log(e.target.value);
            state[e.target.name] = e.target.value;
            this.setState(state);
        };

        getObjeto(e, data){
            //console.log(data);
            this.setState({dataModal: data});
            this.setState({
                isOpen: !this.state.isOpen
            });
            console.log(this.state.dataModal);
        }


        render() {
            return  <section className="">
                {this.state.data.map(item => (
                    <section className="column">
                        <div key={item.id} className="card card-alinhar">
                            <img src={`//127.0.0.1:8000${item.imagem}`} height="50%" width="50%" alt="profile-image"/>
                                <div className="container">
                                    <h4><b>{item.nome}</b></h4>
                                    <p>{item.email}</p>
                                    <p>{item.tipo}</p>
                                    <hr/>

                                    <Modal show={this.state.isOpen}
                                           onClose={this.toggleModal}>
                                        <div className="div-form">
                                            <h3>Cadastrar Contato</h3>
                                            <form>
                                                <input type="text" value={this.state.dataModal.nome} placeholder="nome"/>
                                                <input type="email" value={this.state.dataModal.email} placeholder="email"/>
                                                <input type="tel" value={this.state.dataModal.telefone}  placeholder="telefone"/>
                                                Tipo:
                                                <select value={this.state.dataModal.tipo} name="tipo" form="tipo_form">
                                                    <option value="AMG">Amigo</option>
                                                    <option value="TRAB">Trabalho</option>
                                                </select>
                                                <br/><br/>
                                                <input value={this.state.dataModal.imagem} type="file"/>
                                                <br/><br/>
                                                <button className="estilo-btn" type="submit">Cadastrar</button>
                                            </form>
                                        </div>
                                    </Modal>
                                </div>
                            <button className="estilo-btn" type="button" onClick={((e) => this.getObjeto(e, item))}>Atualizar</button>
                            <button className="estilo-btn" type="button">Deletar</button>
                        </div>
                    </section>
                ))}
                <section className="container-form">
                    <div className="div-form">
                        <h3>Cadastrar Contato</h3>
                    <form onSubmit={this.enviarDados.bind(this)}>
                        <input onChange={this.onChange.bind(this)} value={this.state.nome} name="nome" type="text" placeholder="nome"/>
                        <input onChange={this.onChange.bind(this)} value={this.state.email} name="email" type="email" placeholder="email"/>
                        <input onChange={this.onChange.bind(this)} value={this.state.telefone} name="telefone" type="tel"  placeholder="telefone"/>
                        Tipo:
                        <select value={this.state.tipo} onChange={this.onChange.bind(this)} name="tipo" form="tipo_form">
                            <option value="AMG">Amigo</option>
                            <option value="TRAB">Trabalho</option>
                        </select>
                        <br/><br/>
                        <input id="imagem" value={this.state.imagem} onChange={this.imageUpload.bind(this)} name="imagem" type="file"/>
                        <br/><br/>
                        <button className="estilo-btn" type="">Cadastrar</button>
                    </form>
                    </div>
                </section>

            </section>
        }
    }

    class Modal extends React.Component {
        render() {

            if(!this.props.show) {
                return null;
            }


            const backdropStyle = {
                position: 'fixed',
                top: 0,
                bottom: 0,
                left: 0,
                right: 0,
                backgroundColor: 'rgba(0,0,0,0.3)',
                padding: 50
            };


            const modalStyle = {
                backgroundColor: '#fff',
                borderRadius: 5,
                maxWidth: 400,
                minHeight: 200,
                margin: '0 auto',
                padding: 30
            };

            return (
                <div className="backdrop" style={backdropStyle}>
                    <div className="modal" style={modalStyle}>
                        {this.props.children}

                        <div className="footer">
                            <button className="estilo-btn" onClick={this.props.onClose}>
                                close
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
    }

    Modal.propTypes = {
        onClose: React.PropTypes.func.isRequired,
        show: React.PropTypes.bool,
        children: React.PropTypes.node
    };

    ReactDOM.render(
        <Agenda/>,
        document.getElementById('root')
    );
</script>

</body>

</html>